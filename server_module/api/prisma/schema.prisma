generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ClientGender {
  MALE
  FEMALE
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  phone     String   @unique
  name      String?
  gender    ClientGender
  birthDate DateTime?

  cars      Car[]
  bookings  Booking[]

  @@index([phone])
  @@index([createdAt])
}

model Car {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  makeDisplay  String
  modelDisplay String
  plateDisplay String

  makeNormalized  String
  modelNormalized String
  plateNormalized String @unique

  year     Int?
  color    String?
  bodyType String?

  // ✅ связь с Client (пока nullable для демо)
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  bookings Booking[]

  @@index([clientId])
}

model Service {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String  @unique
  priceRub    Int
  durationMin Int     @default(30)

  bookings Booking[]
}

enum BookingStatus {
  ACTIVE
  CANCELED
  COMPLETED
  PENDING_PAYMENT
}

enum PaymentKind {
  DEPOSIT
  REMAINING
  EXTRA
  REFUND
}

model Booking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Время начала услуги
  dateTime DateTime

  /// Номер поста (1, 2, …)
  bayId Int @default(1)

  /// Буфер в минутах (обычно 15)
  bufferMin Int @default(0)

  /// Сумма брони (например 500 ₽)
  depositRub Int @default(0)

  /// Комментарий клиента
  comment String?

  /// Статус записи
  status BookingStatus @default(PENDING_PAYMENT)

  /// Дедлайн оплаты депозита (удобно только для PENDING_PAYMENT)
  paymentDueAt DateTime?

  /// Отмена
  canceledAt   DateTime?
  cancelReason String?

  carId     String
  serviceId String

  // ✅ прямая ссылка на клиента (пока nullable для демо)
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  car     Car     @relation(fields: [carId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  payments Payment[]

  @@index([carId])
  @@index([serviceId])
  @@index([clientId])
  @@index([dateTime])
  @@index([status])
  @@index([paymentDueAt])
  @@index([bayId])
}

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  paidAt    DateTime @default(now())

  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  amountRub Int
  method    String
  kind      PaymentKind

  @@index([bookingId])
  @@index([paidAt])
  @@index([kind])

  // 1 депозит + 1 доплата (если захочешь больше — уберём это ограничение)
  @@unique([bookingId, kind])
}
