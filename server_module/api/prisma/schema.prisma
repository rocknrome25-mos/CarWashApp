// C:\dev\carwash\server_module\api\prisma\schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ClientGender {
  MALE
  FEMALE
}

enum BookingStatus {
  ACTIVE
  CANCELED
  COMPLETED
  PENDING_PAYMENT
}

enum PaymentKind {
  DEPOSIT
  REMAINING
  EXTRA
  REFUND
}

enum PaymentMethodType {
  CASH
  CARD
  CONTRACT
}

enum UserRole {
  ADMIN
  OWNER
  WASHER
}

enum ShiftStatus {
  OPEN
  CLOSED
}

/** ✅ NEW: planned schedule status */
enum PlannedShiftStatus {
  DRAFT
  PUBLISHED
  CANCELED
}

enum AuditType {
  BOOKING_MOVE
  BOOKING_DELETE
  BOOKING_CHANGE_SERVICE
  BOOKING_CHANGE_BODYTYPE
  BOOKING_DISCOUNT
  BOOKING_START
  BOOKING_FINISH
  PAYMENT_MARKED

  BAY_CLOSE
  BAY_OPEN

  SHIFT_OPEN
  SHIFT_CLOSE

  CLIENT_BLOCK
  CLIENT_UNBLOCK

  WAITLIST_DELETE
}

enum ShiftCashEventType {
  OPEN_FLOAT
  CASH_IN
  CASH_OUT
  CLOSE_COUNT
  HANDOVER
  KEEP_IN_DRAWER
}

enum BookingPhotoKind {
  BEFORE
  AFTER
  DAMAGE
  OTHER
}

/**
 * SERVICES
 */
enum ServiceKind {
  BASE
  ADDON
}

/**
 * ✅ NEW: for washer payout calculations
 * WASH = обычная мойка
 * CHEM = химчистка
 */
enum ServiceLaborCategory {
  WASH
  CHEM
}

model Tenant {
  id        String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String
  isActive Boolean @default(true)

  locations Location[]
  features  TenantFeature[]

  @@index([createdAt])
  @@index([isActive])
}

model TenantFeature {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  key     String
  enabled Boolean @default(true)
  params  Json?

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([key])
  @@index([enabled])
}

model Location {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String @default("demo-tenant")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name     String  @unique
  address  String?
  colorHex String  @default("#2D9CDB")

  baysCount Int @default(2)

  bays        Bay[]
  bookings    Booking[]
  users       User[]
  shifts      Shift[]
  clientLinks ClientLocation[]

  // ✅ services per location
  services Service[]

  // ✅ payout rules per location (editable later in OWNER module)
  washerPayRules WasherPayRule[]

  // ✅ NEW: planned schedule per location
  plannedShifts PlannedShift[]

  cashEvents       ShiftCashEvent[]
  waitlistRequests WaitlistRequest[]

  @@index([createdAt])
  @@index([tenantId])
}

model Bay {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  number   Int
  isActive Boolean @default(true)

  closedReason String?
  closedAt     DateTime?
  reopenedAt   DateTime?

  @@unique([locationId, number])
  @@index([locationId])
  @@index([locationId, isActive])
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  phone String  @unique
  name  String?

  gender    ClientGender?
  birthDate DateTime?

  isBlocked       Boolean   @default(false)
  blockReason     String?
  blockedAt       DateTime?
  blockedByUserId String?

  cars      Car[]
  bookings  Booking[]
  locations ClientLocation[]

  waitlistRequests WaitlistRequest[]

  @@index([phone])
  @@index([createdAt])
  @@index([isBlocked])
}

model ClientLocation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId   String
  locationId String

  isBlocked       Boolean   @default(false)
  blockReason     String?
  blockedAt       DateTime?
  blockedByUserId String?

  lastVisitAt DateTime?

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([clientId, locationId])
  @@index([locationId])
  @@index([clientId])
  @@index([locationId, isBlocked])
}

model Car {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  makeDisplay  String
  modelDisplay String
  plateDisplay String

  makeNormalized  String
  modelNormalized String
  plateNormalized String @unique

  year     Int?
  color    String?
  bodyType String?

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  bookings         Booking[]
  waitlistRequests WaitlistRequest[]

  @@index([clientId])
}

model Service {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ REQUIRED now
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  kind      ServiceKind @default(BASE)
  isActive  Boolean     @default(true)
  sortOrder Int         @default(100)

  // ✅ NEW: для расчёта зарплаты мойщика (30% WASH / 40% CHEM)
  laborCategory ServiceLaborCategory @default(WASH)

  name        String
  priceRub    Int
  durationMin Int @default(30)

  bookings         Booking[]
  waitlistRequests WaitlistRequest[]
  bookingAddons    BookingAddon[]

  @@unique([locationId, name])
  @@index([createdAt])
  @@index([locationId])
  @@index([locationId, kind])
  @@index([locationId, isActive])
  @@index([locationId, sortOrder])
  @@index([locationId, laborCategory])
}

model Booking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  shiftId String?
  shift   Shift? @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  dateTime DateTime
  bayId    Int @default(1)

  requestedBayId Int?

  bufferMin  Int @default(0)
  depositRub Int @default(0)

  discountRub  Int @default(0)
  discountNote String?

  comment   String?
  adminNote String?

  startedAt  DateTime?
  finishedAt DateTime?

  status       BookingStatus @default(PENDING_PAYMENT)
  paymentDueAt DateTime?

  canceledAt   DateTime?
  cancelReason String?

  carId     String
  serviceId String

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  car     Car     @relation(fields: [carId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  payments Payment[]
  addons   BookingAddon[]
  photos   BookingPhoto[]

  convertedFromWaitlists WaitlistRequest[] @relation("WaitlistConvertedBooking")

  @@index([locationId])
  @@index([locationId, bayId])
  @@index([locationId, dateTime])
  @@index([shiftId])
  @@index([carId])
  @@index([serviceId])
  @@index([clientId])
  @@index([dateTime])
  @@index([status])
  @@index([paymentDueAt])
  @@index([bayId])
  @@index([requestedBayId])
}

model BookingAddon {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  qty Int @default(1)

  priceRubSnapshot    Int
  durationMinSnapshot Int

  note String?

  @@unique([bookingId, serviceId])
  @@index([bookingId, createdAt])
  @@index([serviceId])
}

model BookingPhoto {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  kind BookingPhotoKind
  url  String
  note String?

  uploadedByUserId String?
  uploadedByUser   User? @relation("UserToBookingPhoto", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  @@index([bookingId, createdAt])
  @@index([uploadedByUserId])
  @@index([kind])
}

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  paidAt    DateTime @default(now())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  amountRub  Int
  method     String
  methodType PaymentMethodType @default(CARD)
  kind       PaymentKind

  @@unique([bookingId, kind])
  @@index([bookingId])
  @@index([paidAt])
  @@index([kind])
  @@index([methodType])
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  phone    String  @unique
  name     String?
  role     UserRole
  isActive Boolean @default(true)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  shiftOpenAt  DateTime?
  shiftCloseAt DateTime?

  shifts     Shift[]
  audits     AuditEvent[]
  cashEvents ShiftCashEvent[]

  bookingPhotos BookingPhoto[] @relation("UserToBookingPhoto")

  // ✅ washer assignments to live shifts
  shiftWashers ShiftWasher[]

  // ✅ NEW: schedule relations
  plannedShiftsCreated PlannedShift[] @relation("PlannedShiftCreatedBy")
  plannedShiftAssignments PlannedShiftWasher[] @relation("PlannedShiftWasherUser")

  @@index([role])
  @@index([locationId])
  @@index([isActive])
}

model Shift {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  locationId String
  adminId    String

  status   ShiftStatus @default(OPEN)
  openedAt DateTime    @default(now())
  closedAt DateTime?

  // ✅ NEW: link to planned shift (optional)
  plannedShiftId String?
  plannedShift   PlannedShift? @relation(fields: [plannedShiftId], references: [id], onDelete: SetNull)

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  admin    User     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  bookings   Booking[]
  cashEvents ShiftCashEvent[]

  // washers on live shift
  washers ShiftWasher[]

  @@index([locationId, openedAt])
  @@index([adminId, openedAt])
  @@index([status])
  @@index([plannedShiftId])
}

model ShiftCashEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  shiftId    String
  locationId String
  adminId    String

  type      ShiftCashEventType
  amountRub Int
  note      String?

  shift    Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  admin    User     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([shiftId, createdAt])
  @@index([locationId, createdAt])
  @@index([adminId, createdAt])
  @@index([type])
}

model AuditEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  type AuditType

  locationId String?
  userId     String?
  shiftId    String?
  bookingId  String?
  clientId   String?

  reason  String?
  payload Json?

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([createdAt])
  @@index([locationId])
  @@index([userId])
  @@index([shiftId])
  @@index([bookingId])
  @@index([clientId])
}

enum WaitlistStatus {
  WAITING
  INVITED
  CANCELED
  EXPIRED
  CONVERTED
}

model WaitlistRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status WaitlistStatus @default(WAITING)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  desiredDateTime DateTime
  desiredBayId    Int?

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  carId String
  car   Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  comment String?
  reason  String?

  invitedAt DateTime?

  convertedBookingId String?
  convertedBooking   Booking? @relation("WaitlistConvertedBooking", fields: [convertedBookingId], references: [id], onDelete: SetNull)

  @@index([locationId, createdAt])
  @@index([locationId, status])
  @@index([clientId, createdAt])
  @@index([desiredDateTime])
  @@index([convertedBookingId])
}

/* ===================== NEW: Washer payouts + assignments + clock ===================== */

model WasherPayRule {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  category ServiceLaborCategory
  percent  Int @default(30)

  isActive Boolean @default(true)

  @@unique([locationId, category])
  @@index([locationId])
  @@index([category])
  @@index([isActive])
}

enum WasherClockEventType {
  CLOCK_IN
  CLOCK_OUT
}

model ShiftWasher {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shiftId String
  shift   Shift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  washerId String
  washer   User @relation(fields: [washerId], references: [id], onDelete: Cascade)

  bayId Int

  percentWash Int @default(30)
  percentChem Int @default(40)

  clockInAt  DateTime?
  clockOutAt DateTime?

  clockEvents WasherClockEvent[]

  @@unique([shiftId, washerId])
  @@index([shiftId])
  @@index([washerId])
  @@index([shiftId, bayId])
  @@index([clockInAt])
  @@index([clockOutAt])
}

model WasherClockEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  shiftWasherId String
  shiftWasher   ShiftWasher @relation(fields: [shiftWasherId], references: [id], onDelete: Cascade)

  type WasherClockEventType
  at   DateTime @default(now())

  @@index([shiftWasherId, createdAt])
  @@index([type])
}

/* ===================== NEW: Planned schedule (big SaaS) ===================== */

model PlannedShift {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdByUserId String
  createdByUser   User @relation("PlannedShiftCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  startAt DateTime
  endAt   DateTime

  status PlannedShiftStatus @default(DRAFT)
  note   String?

  washers PlannedShiftWasher[]
  shifts  Shift[] // Shift.plannedShiftId

  @@index([locationId, startAt])
  @@index([createdByUserId, createdAt])
  @@index([status])
}

model PlannedShiftWasher {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plannedShiftId String
  plannedShift   PlannedShift @relation(fields: [plannedShiftId], references: [id], onDelete: Cascade)

  washerId String
  washer   User @relation("PlannedShiftWasherUser", fields: [washerId], references: [id], onDelete: Cascade)

  plannedBayId Int?
  note         String?

  @@unique([plannedShiftId, washerId])
  @@index([plannedShiftId, plannedBayId])
  @@index([washerId, createdAt])
}
